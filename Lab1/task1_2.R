library(MASS)
set.seed(42)  # Для воспроизводимости

# 1) Генерация выборки
n <- 100  # Размер выборки
p <- 3    # Размерность вектора

# Параметры многомерного нормального распределения
mu <- c(0, 0, 0)  # Вектор средних
Sigma <- matrix(c(1, 0.5, 0.5, 0.5, 1, 0.3, 0.5, 0.3, 1), nrow = 3)  # Матрица ковариаций

# Генерация случайного вектора X из многомерного нормального распределения
X <- mvrnorm(n, mu, Sigma)

# 2) Оценка ковариационной матрицы
cov_X <- cov(X)

# 3) Вычисление коэффициента корреляции между Xi и Xj (например, X1 и X2)
i <- 1  # Индекс первой переменной
j <- 2  # Индекс второй переменной

# Непосредственное вычисление коэффициента корреляции
r_direct <- cor(X[, i], X[, j])

# Вычисление r_0 по альтернативной формуле
r_0 <- sum(X[, i] * X[, j]) / sqrt(sum(X[, i]^2) * sum(X[, j]^2))

# 4) Проверка гипотезы с использованием Z-преобразования Фишера
Z_n_r0 <- 0.5 * log((1 + r_0) / (1 - r_0))
Z_n_r <- 0.5 * log((1 + r_direct) / (1 - r_direct))  # Фактический коэффициент корреляции
T_stat <- (Z_n_r - Z_n_r0) / sqrt(1 / (n - 3))

# p-значение из стандартного нормального распределения
p_value <- 2 * (1 - pnorm(abs(T_stat)))

# Результаты
list(
  cov_X = cov_X,
  correlation_direct = r_direct,
  correlation_r0 = r_0,
  difference_r0_r_direct = abs(r_0 - r_direct),
  Z_n_r = Z_n_r,
  T_stat = T_stat,
  p_value = p_value
)
